<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Futarchy Markets</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: system-ui, -apple-system, sans-serif; background: #0d1117; color: #e6edf3; line-height: 1.5; }
a { color: #58a6ff; text-decoration: none; }
a:hover { text-decoration: underline; }
code, .mono { font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace; }

.container { max-width: 960px; margin: 0 auto; padding: 16px; }
header { display: flex; align-items: center; gap: 12px; padding: 16px 0; border-bottom: 1px solid #30363d; margin-bottom: 24px; }
header h1 { font-size: 20px; font-weight: 600; }
header .subtitle { color: #8b949e; font-size: 14px; }

/* Filter tabs */
.tabs { display: flex; gap: 4px; margin-bottom: 20px; }
.tab { padding: 6px 16px; border-radius: 6px; border: 1px solid #30363d; background: transparent; color: #8b949e; cursor: pointer; font-size: 14px; }
.tab:hover { color: #e6edf3; border-color: #8b949e; }
.tab.active { background: #21262d; color: #e6edf3; border-color: #58a6ff; }

/* Market cards */
.market-card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: border-color 0.15s; }
.market-card:hover { border-color: #58a6ff; }
.card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 12px; }
.card-question { font-size: 15px; font-weight: 500; flex: 1; }
.card-badges { display: flex; gap: 6px; flex-shrink: 0; }
.badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
.badge-open { background: #1f6f2b; color: #3fb950; }
.badge-resolved { background: #1a3a5c; color: #58a6ff; }
.badge-void { background: #3d2e1f; color: #f0883e; }
.badge-conditional { background: #1a1a2e; color: #b388ff; border: 1px solid #4a3a6e; }

/* Price bar */
.price-bar-container { margin-bottom: 8px; }
.price-bar { display: flex; height: 28px; border-radius: 4px; overflow: hidden; font-size: 13px; font-weight: 600; }
.price-yes { background: #238636; display: flex; align-items: center; justify-content: center; color: #fff; min-width: 36px; transition: width 0.3s ease; }
.price-no { background: #da3633; display: flex; align-items: center; justify-content: center; color: #fff; min-width: 36px; transition: width 0.3s ease; }
.price-void { background: #6e4020; display: flex; align-items: center; justify-content: center; color: #f0883e; width: 100%; }
.price-labels { display: flex; justify-content: space-between; font-size: 12px; color: #8b949e; margin-top: 4px; }

.card-footer { display: flex; gap: 16px; font-size: 13px; color: #8b949e; }

/* Market detail */
.back-link { display: inline-block; margin-bottom: 16px; font-size: 14px; color: #8b949e; }
.back-link:hover { color: #e6edf3; }
.detail-header { margin-bottom: 24px; }
.detail-question { font-size: 22px; font-weight: 600; margin-bottom: 8px; }
.detail-meta { display: flex; flex-wrap: wrap; gap: 16px; font-size: 14px; color: #8b949e; align-items: center; }

.price-display { display: flex; gap: 16px; margin-bottom: 24px; }
.price-box { flex: 1; background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; text-align: center; }
.price-box.yes { border-color: #238636; }
.price-box.no { border-color: #da3633; }
.price-label { font-size: 14px; color: #8b949e; margin-bottom: 4px; }
.price-value { font-size: 36px; font-weight: 700; font-family: 'SF Mono', monospace; }
.price-value.yes { color: #3fb950; }
.price-value.no { color: #f85149; }

.section { margin-bottom: 24px; }
.section-title { font-size: 16px; font-weight: 600; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #30363d; }

table { width: 100%; border-collapse: collapse; font-size: 14px; }
th { text-align: left; padding: 8px; color: #8b949e; font-weight: 500; border-bottom: 1px solid #30363d; }
td { padding: 8px; border-bottom: 1px solid #21262d; }
td.mono { font-family: 'SF Mono', monospace; font-size: 13px; }
tr:hover { background: #1c2128; }

.empty { color: #8b949e; font-style: italic; padding: 20px 0; text-align: center; }

.resolution-banner { padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-weight: 500; }
.resolution-banner.yes { background: #1f6f2b33; border: 1px solid #238636; color: #3fb950; }
.resolution-banner.no { background: #3d1f1f33; border: 1px solid #da3633; color: #f85149; }
.resolution-banner.void { background: #3d2e1f33; border: 1px solid #6e4020; color: #f0883e; }

.rules-box { background: #1a1a2e; border: 1px solid #4a3a6e; border-radius: 8px; padding: 14px 16px; margin-bottom: 20px; font-size: 13px; color: #c0b0e0; }
.rules-box strong { color: #b388ff; }
.rules-box .rule-row { display: flex; gap: 8px; margin-top: 6px; }
.rules-box .rule-label { font-weight: 600; min-width: 50px; }
.rules-box .rule-yes { color: #3fb950; }
.rules-box .rule-no { color: #f85149; }
.rules-box .rule-void { color: #f0883e; }

/* Depth table */
.depth-table { margin-top: 8px; }
.depth-table td.cost { color: #58a6ff; }

/* Collapsible LMSR reference */
details.lmsr-ref { margin-bottom: 24px; }
details.lmsr-ref summary { cursor: pointer; color: #8b949e; font-size: 13px; padding: 8px 0; }
details.lmsr-ref summary:hover { color: #e6edf3; }
details.lmsr-ref .ref-content { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px; font-size: 13px; color: #8b949e; margin-top: 8px; }
details.lmsr-ref .ref-content h4 { color: #e6edf3; margin: 12px 0 6px; font-size: 14px; }
details.lmsr-ref .ref-content h4:first-child { margin-top: 0; }
details.lmsr-ref .ref-content code { color: #58a6ff; background: #0d1117; padding: 1px 5px; border-radius: 3px; }
details.lmsr-ref .ref-content .formula { background: #0d1117; border: 1px solid #30363d; border-radius: 4px; padding: 8px 12px; margin: 6px 0; font-family: 'SF Mono', monospace; font-size: 12px; color: #e6edf3; overflow-x: auto; }
details.lmsr-ref .ref-content p { margin: 4px 0; }

.loading { text-align: center; padding: 40px; color: #8b949e; }
.error-msg { text-align: center; padding: 40px; color: #f85149; }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Futarchy</h1>
    <span class="subtitle">Prediction Markets</span>
  </header>
  <div id="app"><div class="loading">Loading...</div></div>
</div>

<script>
(function() {
  const app = document.getElementById('app');
  let pollTimer = null;
  let currentFilter = 'open';

  function route() {
    clearInterval(pollTimer);
    const hash = location.hash || '#/';
    const marketMatch = hash.match(/^#\/market\/(\d+)$/);
    if (marketMatch) {
      renderMarketDetail(parseInt(marketMatch[1]));
    } else {
      renderMarketList();
    }
  }

  async function api(path) {
    const resp = await fetch('/v1' + path);
    if (!resp.ok) throw new Error(`API ${resp.status}`);
    return resp.json();
  }

  function pct(v) { return (parseFloat(v) * 100).toFixed(1); }
  function fmtPrice(v) { return (parseFloat(v) * 100).toFixed(1) + '\u00a2'; }
  function fmtVal(v) { return parseFloat(v).toFixed(2); }
  function fmtCurrency(v) { return '$' + parseFloat(v).toFixed(0); }
  function fmtDate(iso) {
    if (!iso) return '\u2014';
    const d = new Date(iso);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }
  function fmtTime(iso) {
    if (!iso) return '\u2014';
    const d = new Date(iso);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
  }
  function isConditional(m) {
    return m.metadata && m.metadata.market_type === 'conditional';
  }
  function badgeClass(status) {
    return 'badge badge-' + status;
  }

  // --- LMSR math (client-side, for depth table) ---

  function lmsrPriceImpact(b, refAmount) {
    // Price impact of buying refAmount of YES starting from 50/50
    // d = b * ln(2 * exp(refAmount/b) - 1)
    var bf = parseFloat(b);
    var d = bf * Math.log(2 * Math.exp(refAmount / bf) - 1);
    var priceAfter = Math.exp(d / bf) / (Math.exp(d / bf) + 1);
    return (priceAfter - 0.5) / 0.5;
  }

  function liquidityLabel(b, n) {
    var impact = lmsrPriceImpact(b, 10); // $10 reference trade
    if (impact < 0.005) return { label: 'Deep', color: '#3fb950' };
    if (impact < 0.02)  return { label: 'Moderate', color: '#f0883e' };
    if (impact < 0.10)  return { label: 'Thin', color: '#f85149' };
    return { label: 'Very Thin', color: '#da3633' };
  }

  function depthTable(b, q) {
    // Compute cost to move YES price to target probabilities
    var bf = parseFloat(b);
    var qy = parseFloat(q.yes || '0');
    var qn = parseFloat(q.no || '0');
    var targets = [0.6, 0.7, 0.8, 0.9, 0.95];
    var rows = [];
    for (var i = 0; i < targets.length; i++) {
      var tp = targets[i];
      // delta_q = b * ln(tp / (1-tp)) + qn - qy  (for normalized)
      var mn = Math.min(qy, qn);
      var qyn = qy - mn;
      var qnn = qn - mn;
      var othersSum = Math.exp(qnn / bf);
      var ratio = tp * othersSum / (1 - tp);
      var qNewNorm = bf * Math.log(ratio);
      var deltaQ = qNewNorm - qyn;
      if (deltaQ <= 0) continue;
      // cost = b * ln(exp((qyn+deltaQ)/bf) + exp(qnn/bf)) - b * ln(exp(qyn/bf) + exp(qnn/bf))
      var costAfter = bf * Math.log(Math.exp((qyn + deltaQ) / bf) + Math.exp(qnn / bf));
      var costBefore = bf * Math.log(Math.exp(qyn / bf) + Math.exp(qnn / bf));
      var cost = costAfter - costBefore;
      rows.push({ target: (tp * 100).toFixed(0) + '%', cost: cost.toFixed(2), shares: deltaQ.toFixed(1) });
    }
    return rows;
  }

  // --- Market List ---

  async function renderMarketList() {
    app.innerHTML = renderTabs() + '<div id="markets-area"><div class="loading">Loading markets...</div></div>';
    bindTabs();
    await fetchAndRenderMarkets();
    pollTimer = setInterval(fetchAndRenderMarkets, 30000);
  }

  function renderTabs() {
    return `<div class="tabs">
      <button class="tab${currentFilter === 'open' ? ' active' : ''}" data-filter="open">Open</button>
      <button class="tab${currentFilter === 'settled' ? ' active' : ''}" data-filter="settled">Settled</button>
      <button class="tab${currentFilter === 'all' ? ' active' : ''}" data-filter="all">All</button>
    </div>`;
  }

  function bindTabs() {
    document.querySelectorAll('.tab').forEach(t => {
      t.onclick = () => {
        currentFilter = t.dataset.filter;
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        t.classList.add('active');
        fetchAndRenderMarkets();
      };
    });
  }

  async function fetchAndRenderMarkets() {
    try {
      const statusParam = currentFilter === 'settled' ? 'resolved,void' : currentFilter;
      const params = currentFilter !== 'all' ? '?status=' + statusParam : '';
      const markets = await api('/markets' + params);
      const area = document.getElementById('markets-area');
      if (!area) return;
      if (markets.length === 0) {
        area.innerHTML = '<div class="empty">No markets found.</div>';
        return;
      }
      area.innerHTML = markets.map(m => {
        const yesP = m.prices.yes ? parseFloat(m.prices.yes) : 0;
        const noP = m.prices.no ? parseFloat(m.prices.no) : 0;
        const isVoid = m.status === 'void';
        const yesPct = m.status === 'open' ? Math.max(yesP * 100, 5) : (m.resolution === 'yes' ? 100 : 0);
        const noPct = m.status === 'open' ? Math.max(noP * 100, 5) : (m.resolution === 'no' ? 100 : 0);
        const conditional = isConditional(m);
        const liq = liquidityLabel(m.b, m.outcomes.length);

        let priceBar;
        if (isVoid) {
          priceBar = `<div class="price-bar"><div class="price-void">VOID \u2014 positions refunded</div></div>`;
        } else if (m.status === 'open') {
          priceBar = `<div class="price-bar">
            <div class="price-yes" style="width:${yesPct}%">${pct(m.prices.yes)}%</div>
            <div class="price-no" style="width:${noPct}%">${pct(m.prices.no)}%</div>
          </div>
          <div class="price-labels"><span>Yes ${fmtPrice(m.prices.yes)}</span><span>No ${fmtPrice(m.prices.no)}</span></div>`;
        } else {
          priceBar = `<div class="price-bar">
            <div class="price-yes" style="width:${yesPct}%">${m.resolution === 'yes' ? 'YES' : ''}</div>
            <div class="price-no" style="width:${noPct}%">${m.resolution === 'no' ? 'NO' : ''}</div>
          </div>`;
        }

        return `<div class="market-card" onclick="location.hash='#/market/${m.market_id}'">
          <div class="card-header">
            <span class="card-question">${esc(m.question)}</span>
            <div class="card-badges">
              ${conditional ? '<span class="badge badge-conditional">Conditional</span>' : ''}
              <span class="${badgeClass(m.status)}">${m.status}</span>
            </div>
          </div>
          <div class="price-bar-container">${priceBar}</div>
          <div class="card-footer">
            <span>${m.num_trades} trade${m.num_trades !== 1 ? 's' : ''}</span>
            <span>Liquidity: ${fmtCurrency(m.liquidity)}</span>
            ${m.status === 'open' && m.deadline ? `<span>Closes ${fmtDate(m.deadline)}</span>` : ''}
            ${m.resolved_at ? `<span>${m.status === 'void' ? 'Voided' : 'Settled'} ${fmtTime(m.resolved_at)}</span>` : `<span>${fmtTime(m.created_at)}</span>`}
          </div>
        </div>`;
      }).join('');
    } catch (e) {
      const area = document.getElementById('markets-area');
      if (area) area.innerHTML = '<div class="error-msg">Failed to load markets. Retrying...</div>';
    }
  }

  // --- Market Detail ---

  async function renderMarketDetail(id) {
    app.innerHTML = '<div class="loading">Loading market...</div>';
    await fetchAndRenderDetail(id);
    pollTimer = setInterval(() => fetchAndRenderDetail(id), 15000);
  }

  async function fetchAndRenderDetail(id) {
    try {
      const [m, trades, positions] = await Promise.all([
        api('/markets/' + id),
        api('/markets/' + id + '/trades'),
        api('/markets/' + id + '/positions'),
      ]);

      const prUrl = m.metadata && m.metadata.pr_url;
      const conditional = isConditional(m);

      let resolution = '';
      if (m.status === 'resolved') {
        resolution = `<div class="resolution-banner ${m.resolution}">Resolved: <strong>${m.resolution.toUpperCase()}</strong>${m.resolved_at ? ' on ' + fmtTime(m.resolved_at) : ''}</div>`;
      } else if (m.status === 'void') {
        resolution = `<div class="resolution-banner void">Market voided \u2014 all positions refunded${m.resolved_at ? ' on ' + fmtTime(m.resolved_at) : ''}</div>`;
      }

      let rulesBox = '';
      if (conditional) {
        rulesBox = `<div class="rules-box">
          <strong>Conditional Market</strong>${m.deadline ? ' \u2014 closes ' + fmtDate(m.deadline) : ''}
          <div class="rule-row"><span class="rule-label rule-yes">YES</span> PR is merged</div>
          <div class="rule-row"><span class="rule-label rule-no">NO</span> PR is closed without merge</div>
          <div class="rule-row"><span class="rule-label rule-void">VOID</span> Deadline expires with no resolution \u2014 positions refunded</div>
        </div>`;
      }

      // Depth table for open markets
      let depthSection = '';
      if (m.status === 'open') {
        const rows = depthTable(m.b, m.q);
        if (rows.length > 0) {
          depthSection = `<div class="section">
            <div class="section-title">Market Depth</div>
            <p style="font-size:13px;color:#8b949e;margin-bottom:12px">Cost to move the YES price to a target probability.</p>
            <table class="depth-table">
              <tr><th>Target</th><th>Cost</th><th>Shares</th></tr>
              ${rows.map(r => `<tr>
                <td class="mono">${r.target}</td>
                <td class="mono cost">$${r.cost}</td>
                <td class="mono">${r.shares}</td>
              </tr>`).join('')}
            </table>
          </div>`;
        }
      }

      // LMSR reference (collapsible)
      const lmsrRef = `<details class="lmsr-ref">
        <summary>LMSR Reference \u2014 how this market works</summary>
        <div class="ref-content">
          <h4>Cost Function</h4>
          <div class="formula">C(q) = b \u00b7 ln( \u03a3 e^(q\u1d62 / b) )</div>
          <p>The total amount collected by the market maker. Trading costs are <code>C(after) \u2212 C(before)</code>.</p>

          <h4>Prices (Probabilities)</h4>
          <div class="formula">p\u1d62 = e^(q\u1d62 / b) / \u03a3 e^(q\u2c7c / b)</div>
          <p>Softmax over quantities. Always sum to 1.</p>

          <h4>Liquidity Parameter (b)</h4>
          <div class="formula">b = ${fmtVal(m.b)}</div>
          <p>Controls market depth. Higher <code>b</code> = more capital needed to move prices. A $10 trade at 50/50 moves the price by ${(lmsrPriceImpact(m.b, 10) * 100).toFixed(2)}%.</p>

          <h4>Max Market Maker Loss</h4>
          <div class="formula">max loss = b \u00b7 ln(n) = ${fmtVal(m.b)} \u00b7 ln(${m.outcomes.length}) = $${fmtVal(m.liquidity)}</div>
          <p>The funding required to create this market. This is a fixed bound \u2014 the AMM can never lose more than this, regardless of how the market trades. The bound holds because LMSR is a reversible market maker: any trade can be undone, so the worst case never changes.</p>

          <h4>This Market</h4>
          <table>
            <tr><td style="color:#8b949e;width:140px">Liquidity (b)</td><td class="mono">${fmtVal(m.b)}</td></tr>
            <tr><td style="color:#8b949e">Funding / Max Loss</td><td class="mono">$${fmtVal(m.liquidity)}</td></tr>
            <tr><td style="color:#8b949e">Outcomes</td><td class="mono">${m.outcomes.length} (${m.outcomes.join(', ')})</td></tr>
            <tr><td style="color:#8b949e">AMM Account</td><td class="mono">#${m.amm_account_id}</td></tr>
            ${Object.keys(m.q).map(o => `<tr><td style="color:#8b949e">q[${o}]</td><td class="mono">${fmtVal(m.q[o])}</td></tr>`).join('')}
          </table>
        </div>
      </details>`;

      const liq = liquidityLabel(m.b, m.outcomes.length);

      app.innerHTML = `
        <a class="back-link" href="#/">\u2190 All Markets</a>
        <div class="detail-header">
          <div class="detail-question">${esc(m.question)}</div>
          <div class="detail-meta">
            ${conditional ? '<span class="badge badge-conditional">Conditional</span>' : ''}
            <span class="${badgeClass(m.status)}">${m.status}</span>
            ${m.status === 'open' && m.deadline ? `<span>Closes ${fmtDate(m.deadline)}</span>` : ''}
            <span>Liquidity: ${fmtCurrency(m.liquidity)} <span style="color:${liq.color}">(${liq.label})</span></span>
            <span>Volume: <span class="mono">${fmtVal(m.volume)}</span></span>
            <span>${m.num_trades} trade${m.num_trades !== 1 ? 's' : ''}</span>
            ${prUrl ? `<a href="${esc(prUrl)}" target="_blank" rel="noopener">View PR</a>` : ''}
          </div>
        </div>

        ${resolution}
        ${rulesBox}

        ${m.status === 'open' ? `<div class="price-display">
          <div class="price-box yes">
            <div class="price-label">Yes</div>
            <div class="price-value yes">${pct(m.prices.yes)}%</div>
            <div class="price-label">${fmtPrice(m.prices.yes)}</div>
          </div>
          <div class="price-box no">
            <div class="price-label">No</div>
            <div class="price-value no">${pct(m.prices.no)}%</div>
            <div class="price-label">${fmtPrice(m.prices.no)}</div>
          </div>
        </div>` : ''}

        ${depthSection}

        <div class="section">
          <div class="section-title">Trades (${trades.length})</div>
          ${trades.length === 0 ? '<div class="empty">No trades yet.</div>' : `<table>
            <tr><th>ID</th><th>Outcome</th><th>Amount</th><th>Price</th><th>Value</th><th>Time</th></tr>
            ${trades.slice().reverse().map(t => `<tr>
              <td class="mono">${t.trade_id}</td>
              <td><span style="color:${t.outcome === 'yes' ? '#3fb950' : '#f85149'}">${t.outcome}</span></td>
              <td class="mono">${fmtVal(t.amount)}</td>
              <td class="mono">${fmtPrice(t.price)}</td>
              <td class="mono">${fmtVal(t.value)}</td>
              <td>${fmtTime(t.created_at)}</td>
            </tr>`).join('')}
          </table>`}
        </div>

        <div class="section">
          <div class="section-title">Positions (${positions.length})</div>
          ${positions.length === 0 ? '<div class="empty">No positions.</div>' : `<table>
            <tr><th>Account</th><th>Yes</th><th>No</th></tr>
            ${positions.map(p => `<tr>
              <td class="mono">${p.account_id}</td>
              <td class="mono" style="color:#3fb950">${fmtVal(p.positions.yes || '0')}</td>
              <td class="mono" style="color:#f85149">${fmtVal(p.positions.no || '0')}</td>
            </tr>`).join('')}
          </table>`}
        </div>

        ${lmsrRef}
      `;
    } catch (e) {
      app.innerHTML = `<a class="back-link" href="#/">\u2190 All Markets</a><div class="error-msg">Market not found or failed to load.</div>`;
    }
  }

  function esc(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  window.addEventListener('hashchange', route);
  route();
})();
</script>
</body>
</html>
